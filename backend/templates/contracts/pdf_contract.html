{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Agreement {{ contract.reference_code }} - Dewlon Systems</title>
    <style>
        /* --- COLOR PALETTE & VARIABLES --- */
        :root {
            --primary-green: #1A4D2E;
            --secondary-cream: #F9F7F2;
            --accent-orange: #E67E22;
            --text-dark: #2C3E50;
            --text-light: #546E7A;
            --white: #FFFFFF;
            --border-color: #E0E0E0;
        }

        /* --- GLOBAL STYLES --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary-cream);
            color: var(--text-dark);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
            font-size: 10.5pt;
        }

        /* --- THE DOCUMENT PAPER --- */
        .document-paper {
            max-width: 850px;
            margin: 0 auto;
            background: var(--white);
            box-shadow: 0 10px 30px rgba(26, 77, 46, 0.15);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .document-paper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: var(--primary-green);
        }

        /* --- HEADER SECTION --- */
        .header {
            padding: 50px 50px 30px 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid var(--primary-green);
        }

        .company-branding {
            flex: 1;
        }

        .logo-container {
            margin-bottom: 15px;
        }

        .logo-container img {
            max-height: 70px;
            width: auto;
            display: block;
        }

        .company-name {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-green);
            margin: 0 0 5px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .company-details {
            font-size: 0.85em;
            color: var(--text-light);
            margin: 0;
        }

        .document-title-block {
            text-align: right;
        }

        .document-title {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-green);
            margin: 0;
            line-height: 1.1;
            text-transform: uppercase;
        }

        .contract-ref {
            font-size: 1em;
            color: var(--accent-orange);
            font-weight: 600;
            margin-top: 10px;
            display: block;
            font-family: 'Courier New', Courier, monospace;
        }

        /* --- CONTENT CONTAINER --- */
        .content-container {
            padding: 40px 50px;
        }

        /* --- PARTIES SECTION --- */
        .parties-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .party-block h3 {
            font-size: 0.85em;
            text-transform: uppercase;
            color: var(--text-light);
            letter-spacing: 1.5px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-orange);
            display: inline-block;
        }

        .party-block p {
            margin: 5px 0;
            font-size: 1em;
        }

        /* --- SCOPE OF WORK --- */
        .scope-section {
            background-color: var(--secondary-cream);
            padding: 25px;
            border-radius: 4px;
            border-left: 5px solid var(--primary-green);
            margin-bottom: 40px;
        }

        .scope-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .scope-header h3 {
            margin: 0;
            color: var(--primary-green);
            text-transform: uppercase;
            font-size: 1.1em;
        }

        .scope-price {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-dark);
        }

        .scope-text {
            white-space: pre-line;
            color: var(--text-dark);
            line-height: 1.8;
        }

        /* --- TERMS AND CONDITIONS --- */
        .terms-section {
            margin-bottom: 40px;
        }

        .terms-section h2 {
            font-size: 1.4em;
            color: var(--primary-green);
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 10px;
            margin-bottom: 25px;
            text-transform: uppercase;
        }

        .term-item {
            margin-bottom: 22px;
            page-break-inside: avoid;
        }

        .term-title {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 1em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }

        .term-title::before {
            content: '';
            display: inline-block;
            width: 7px;
            height: 7px;
            background-color: var(--accent-orange);
            border-radius: 50%;
            margin-right: 9px;
            flex-shrink: 0;
        }

        .term-content {
            color: var(--text-light);
            font-size: 0.93em;
            text-align: justify;
            line-height: 1.65;
            margin-left: 16px;
        }

        .term-content strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        /* --- SIGNATURES --- */
        .signature-section {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid var(--primary-green);
            page-break-inside: avoid;
        }

        .signature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            margin-top: 40px;
        }

        .signature-block {
            position: relative;
        }

        .signature-label {
            font-size: 0.85em;
            text-transform: uppercase;
            color: var(--text-light);
            font-weight: 700;
            margin-bottom: 15px;
            display: block;
        }

        .signature-line {
            border-bottom: 2px solid var(--text-dark);
            height: 70px;
            position: relative;
            margin-bottom: 10px;
        }

        .signature-image {
            max-height: 60px;
            width: auto;
            position: absolute;
            bottom: 5px;
            left: 0;
        }

        .sign-details {
            font-size: 0.85em;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* --- FOOTER --- */
        .footer-section {
            background-color: var(--primary-green);
            color: var(--white);
            padding: 20px 50px;
            text-align: center;
            font-size: 0.8em;
            margin-top: 40px;
        }

        .footer-section p {
            margin: 5px 0;
            opacity: 0.9;
        }

        /* --- PRINT OPTIMIZATION --- */
        @media print {
            body { 
                background: none; 
                padding: 0; 
                -webkit-print-color-adjust: exact; 
                font-size: 9.5pt;
            }
            .document-paper { 
                box-shadow: none; 
                border: none;
                width: 100%;
                max-width: 100%;
                margin: 0;
            }
            .header, .content-container, .footer-section {
                padding-left: 30px;
                padding-right: 30px;
            }
            .term-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <div class="document-paper">
        
        <!-- HEADER -->
        <div class="header">
            <div class="company-branding">
                <div class="logo-container">
                    <!-- Logo: Use base64 or static path (WeasyPrint handles static with base_url) -->
                    <img src="{% static 'logo.png' %}" alt="Dewlon Systems Logo" onerror="this.style.display='none'">
                </div>
                <h1 class="company-name">Dewlon Systems</h1>
                <div class="company-details">
                    <p>Imara Daima, Nairobi, Kenya</p>
                    <p>0728722746 &bull; contact@dewlons.com</p>
                </div>
            </div>

            <div class="document-title-block">
                <h2 class="document-title">Service<br>Agreement</h2>
                <span class="contract-ref">REF: {{ contract.reference_code }}</span>
            </div>
        </div>

        <div class="content-container">

            <!-- PARTIES -->
            <div class="parties-section">
                <div class="party-block">
                    <h3>The Client</h3>
                    <p><strong>{{ contract.client_name }}</strong></p>
                    <p>{{ contract.client_email }}</p>
                </div>
                <div class="party-block">
                    <h3>Agreement Details</h3>
                    <p><strong>Date:</strong> {{ contract.signed_at|date:"F j, Y" }}</p>
                    <p><strong>Location:</strong> {{ contract.place_of_signing }}</p>
                </div>
            </div>

            <!-- SCOPE OF WORK -->
            <div class="scope-section">
                <div class="scope-header">
                    <h3>Scope of Services</h3>
                    <span class="scope-price">Total: {{ contract.amount }}</span>
                </div>
                <div class="scope-text">{{ contract.service_description }}</div>
            </div>

            <!-- TERMS AND CONDITIONS (15 Comprehensive Clauses) -->
            <div class="terms-section">
                <h2>Terms and Conditions</h2>

                <div class="term-item">
                    <div class="term-title">1. Definitions and Interpretation</div>
                    <div class="term-content">
                        In this Agreement, unless the context otherwise requires: "Client" refers to the individual or entity signing this contract; "Provider" refers to Dewlon Systems, a company registered under the laws of Kenya; "Services" means the professional services described in the Scope of Services section; "Effective Date" is the date this Agreement is fully executed by both parties. Headings are for convenience only and do not affect interpretation. References to statutory provisions include amendments and re-enactments.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">2. Scope of Services</div>
                    <div class="term-content">
                        The Provider agrees to deliver the Services described in the Scope of Services section with reasonable skill, care, and diligence, in accordance with industry standards and applicable laws. Any additional services requested by the Client beyond the agreed scope shall be subject to a separate written agreement and additional fees. The Provider reserves the right to subcontract portions of the Services with prior written notice to the Client, provided that the Provider remains liable for the performance of any subcontractor.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">3. Payment Terms</div>
                    <div class="term-content">
                        The Client agrees to pay the total amount specified in the Scope of Services within seventy-two (72) hours of invoice receipt. Payment shall be made via the agreed method (bank transfer, mobile money, or card payment). Late payments shall incur interest at a rate of 2% per month or the maximum rate permitted by law, whichever is lower. The Provider reserves the right to suspend Services until all outstanding invoices are settled in full. All fees are exclusive of applicable taxes unless otherwise stated.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">4. Commencement and Delivery</div>
                    <div class="term-content">
                        Services shall commence only after (a) this Agreement is fully executed by both parties, (b) the initial payment or deposit is received and confirmed, and (c) the Client has provided all necessary information, access, and materials required for service delivery. The Provider shall use commercially reasonable efforts to meet agreed timelines but does not guarantee specific delivery dates unless expressly stated in writing. Time is not of the essence unless explicitly agreed in writing.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">5. Client Obligations</div>
                    <div class="term-content">
                        The Client agrees to: (a) provide accurate and complete information necessary for service delivery; (b) respond to Provider inquiries within reasonable timeframes; (c) grant necessary access to systems, accounts, or premises as required; (d) designate a single point of contact for project coordination; and (e) comply with all applicable laws and regulations in their use of the Services. Failure to meet these obligations may result in delays for which the Provider is not liable, and may constitute grounds for termination under Clause 10.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">6. Intellectual Property Rights</div>
                    <div class="term-content">
                        All intellectual property created by the Provider in the course of delivering Services, including but not limited to designs, code, documentation, reports, and methodologies, shall remain the exclusive property of the Provider until full payment is received. Upon full payment, the Client receives a non-exclusive, non-transferable, perpetual license to use the deliverables for their intended business purpose. Pre-existing intellectual property of either party remains their sole property and is not transferred under this Agreement.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">7. Confidentiality</div>
                    <div class="term-content">
                        Both parties agree to maintain the confidentiality of all proprietary information disclosed during the engagement, including business strategies, technical data, customer lists, financial information, and trade secrets. Confidential information shall not be disclosed to third parties without prior written consent, except as required by law or regulatory authority. This obligation survives termination of this Agreement for a period of three (3) years. Each party shall implement reasonable security measures to protect confidential information from unauthorized access or disclosure.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">8. Data Protection and Privacy</div>
                    <div class="term-content">
                        The Provider shall process any personal data provided by the Client in accordance with the Kenya Data Protection Act, 2019, and applicable international standards including GDPR where relevant. The Client warrants that they have obtained all necessary consents for sharing personal data with the Provider and that such data is accurate and up to date. Both parties agree to implement appropriate technical and organizational measures to protect data against unauthorized access, loss, alteration, or destruction. Data processing agreements shall be executed separately where required by law.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">9. Limitation of Liability</div>
                    <div class="term-content">
                        To the maximum extent permitted by law, the Provider shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including but not limited to loss of profits, revenue, data, goodwill, or business opportunities, arising from or related to this Agreement. The Provider total aggregate liability under this Agreement shall not exceed the total fees paid by the Client under this Agreement in the twelve (12) months preceding the claim. This limitation does not apply to liability for gross negligence, willful misconduct, breach of confidentiality obligations, or infringement of intellectual property rights.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">10. Term and Termination</div>
                    <div class="term-content">
                        This Agreement commences on the Effective Date and continues until completion of the Services, unless terminated earlier. Either party may terminate this Agreement with seven (7) days written notice for material breach by the other party, provided the breach remains uncured after the notice period. The Provider may terminate immediately for non-payment exceeding fourteen (14) days. Upon termination, the Client shall pay for all Services rendered and reasonable expenses incurred up to the termination date. Sections 6, 7, 8, 9, 12, 13, and 15 shall survive termination.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">11. Force Majeure</div>
                    <div class="term-content">
                        Neither party shall be liable for failure or delay in performing obligations under this Agreement due to circumstances beyond their reasonable control, including but not limited to acts of God, war, civil unrest, government actions, pandemics, natural disasters, widespread infrastructure failures, or internet service disruptions. The affected party shall notify the other promptly in writing and use reasonable efforts to mitigate the impact and resume performance. If the force majeure event continues for more than thirty (30) days, either party may terminate this Agreement without liability.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">12. Dispute Resolution</div>
                    <div class="term-content">
                        Any dispute arising from this Agreement shall first be addressed through good-faith negotiation between designated representatives of the parties within fourteen (14) days of written notice. If unresolved, the dispute shall be submitted to mediation under the rules of the Chartered Institute of Arbitrators, Kenya Branch, with costs shared equally. If mediation fails within thirty (30) days, the dispute shall be finally resolved by binding arbitration in Nairobi, Kenya, under the Arbitration Act of Kenya. The arbitral award shall be final and enforceable in any court of competent jurisdiction. Each party bears its own legal costs unless the arbitrator awards otherwise.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">13. Governing Law and Jurisdiction</div>
                    <div class="term-content">
                        This Agreement shall be governed by and construed in accordance with the laws of the Republic of Kenya, without regard to its conflict of laws principles. The parties submit to the exclusive jurisdiction of the courts of Kenya for any matters not subject to arbitration under Clause 12. Any legal notices shall be sent to the addresses provided during contract execution or as subsequently updated in writing via email with read receipt or registered post. Changes to contact details must be communicated in writing to remain effective.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">14. Amendments and Entire Agreement</div>
                    <div class="term-content">
                        This Agreement constitutes the entire understanding between the parties regarding the subject matter and supersedes all prior discussions, proposals, quotations, or agreements, whether oral or written. Any amendment, modification, or waiver of any provision must be in writing, signed by authorized representatives of both parties, and expressly reference this Agreement. No failure or delay by either party in exercising any right shall operate as a waiver. No waiver of any provision shall be effective unless in writing and signed by the waiving party, and shall be limited to the specific instance and purpose stated.
                    </div>
                </div>

                <div class="term-item">
                    <div class="term-title">15. Electronic Signatures and Counterparts</div>
                    <div class="term-content">
                        The parties acknowledge that electronic signatures, including digital images of handwritten signatures, typed names, or click-to-sign mechanisms, are legally binding under the Kenya Information and Communications Act and the Electronic Transactions Act. This Agreement may be executed in counterparts, each of which shall be deemed an original, and all of which together constitute one instrument. Transmission of a signed copy by email, secure electronic signature platform, or other electronic means shall be sufficient to evidence execution. The parties waive any requirement for physical signature or exchange of original documents.
                    </div>
                </div>

            </div>

            <!-- SIGNATURES -->
            <div class="signature-section">
                <div class="signature-grid">
                    
                    <!-- Client Signature (User) - BASE64 EMBEDDED -->
                    <div class="signature-block">
                        <span class="signature-label">Signed by Client</span>
                        <div class="signature-line">
                            {% if user_signature_b64 %}
                                <!-- ✅ Full base64 data URI from tasks.py -->
                                <img src="{{ user_signature_b64 }}" alt="Client Signature" class="signature-image">
                            {% else %}
                                <!-- Fallback text if signature not available -->
                                <span style="color: #999; font-style: italic; font-size: 0.9em; position: absolute; bottom: 5px; left: 0;">
                                    Signature on file
                                </span>
                            {% endif %}
                        </div>
                        <div class="sign-details">
                            <p><strong>Name:</strong> {{ contract.client_name }}</p>
                            <p><strong>Date:</strong> {{ contract.signed_at|date:"F j, Y" }}</p>
                            <p><strong>Place:</strong> {{ contract.place_of_signing }}</p>
                        </div>
                    </div>

                    <!-- Dewlon Systems Director Signature - BASE64 EMBEDDED -->
                    <div class="signature-block">
                        <span class="signature-label">For Dewlon Systems</span>
                        <div class="signature-line">
                            {% if director_signature_b64 %}
                                <!-- ✅ Full base64 data URI from tasks.py -->
                                <img src="{{ director_signature_b64 }}" alt="Director Signature" class="signature-image">
                            {% else %}
                                <!-- Fallback: static path (may not work in PDF, but safe) -->
                                <img src="{% static 'signatures/director-signature.png' %}" alt="Director Signature" class="signature-image">
                            {% endif %}
                        </div>
                        <div class="sign-details">
                            <p><strong>Name:</strong> Director, Dewlon Systems</p>
                            <p><strong>Date:</strong> {{ contract.signed_at|date:"F j, Y" }}</p>
                            <p><strong>Place:</strong> Nairobi, Kenya</p>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="footer-section">
            <p><strong>Dewlon Systems</strong></p>
            <p>Imara Daima, Nairobi | 0728722746 | contact@dewlons.com</p>
            <p style="font-size: 0.75em; margin-top: 10px; opacity: 0.7;">This is a legally binding agreement. Electronic signatures are valid under Kenyan law.</p>
        </div>

    </div>

</body>
</html>